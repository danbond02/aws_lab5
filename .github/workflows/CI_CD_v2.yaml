name: Deploy to EC2

on:
  push:
    branches:
      - "main"

jobs:
  CI:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Branch
        uses: actions/checkout@v2

      - name: Create ZIP Archive
        run: |
          zip -r branch-files.zip .

      - name: Upload ZIP Artifact
        uses: actions/upload-artifact@v2
        with:
          name: branch-files
          path: branch-files.zip

  CD:
    runs-on: ubuntu-latest
    needs: [CI]
    if: ${{ always() }}
    steps:
      - name: Download Lambda branch-files.zip
        uses: actions/download-artifact@v2
        with:
          name: branch-files

      - name: Validate downloaded artifact
        run: ls -l branch-files.zip

      - name: Upload artifact to S3
        uses: aws-actions/s3-sync@v1
        with:
          bucket: aws-master-lab5
          source: branch-files.zip
          dest: branch-files.zip
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_SECRET_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Copy artifact to EC2
        run: |
          scp branch-files.zip ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:/home/ubuntu/

      - name: Extract artifact on EC2
        run: |
          ssh ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "unzip /home/ubuntu/branch-files.zip -d /home/ubuntu/branch-files"

      - name: Run Bash Script to Deploy App
        run: |
          ssh ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} "chmod +x /home/ubuntu/branch-files/deploy.sh && /home/ubuntu/branch-files/deploy.sh"
